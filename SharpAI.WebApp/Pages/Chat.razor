@page "/"
@page "/chat"
@using Microsoft.JSInterop
@using Radzen
@using Radzen.Blazor
@using SharpAI.Shared
@using SharpAI.WebApp.ViewModels
@using System.Linq
@inject ChatViewModel Vm
@inject IJSRuntime JS

<RadzenHeading Size="H1" Text="Chat" />

<style>
  .message-wrapper { position: relative; }
  /* Ensure Radzen card allows visible overflow for the overlay */
  .message-wrapper .rz-card, .message-wrapper .rz-card-content { overflow: visible !important; }
  .message-wrapper .translate-overlay {
    display: none;
    position: absolute;
    right: 8px;
    bottom: 8px;
    z-index: 9999;
    gap: 6px;
    align-items: center;
    pointer-events: auto;
    background: rgba(255,255,255,0.95);
    padding: 4px 6px;
    border-radius: 6px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.12);
  }
  .message-wrapper:hover .translate-overlay { display: flex; }
</style>

<RadzenRow Gap="1.5rem">
    <RadzenColumn Size="12" SizeLG="8">
        <RadzenCard Variant="Variant.Outlined" Title="Conversation">
            <ChildContent>
                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween" Gap="1rem" Style="margin-bottom: 0.75rem;">
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.75rem">
                        <RadzenText Text="@($"Model: {(Vm.IsModelLoaded == true ? $"{Vm.LoadedModelName} loaded" : "Not loaded")}")" Style="@($"color: {(Vm.IsModelLoaded == true ? "green" : "red")};")" />
                        <RadzenText Text="@($"Context: {Vm.ContextLabel}")" TextStyle="TextStyle.Caption" />
                    </RadzenStack>
                    <RadzenButton ButtonStyle="ButtonStyle.Light" Text="New Context" Size="ButtonSize.Small" Click="@Vm.RenewAsync" />
                </RadzenStack>

                <div style="height: 420px; overflow-y: auto;" @ref="messageContainer">
                    @if (Vm.Messages.Count == 0)
                    {
                        <RadzenText Text="No messages yet." TextStyle="TextStyle.Caption" />
                    }
                    else
                    {
                        <RadzenStack Gap="0.75rem">
                        @foreach (var message in Vm.Messages)
                            {
                                <div class="message-wrapper">
                                    <RadzenCard Variant="Variant.Outlined">
                                        <ChildContent>
                                            <RadzenStack Gap="0.35rem">
                                                <RadzenText Text="@message.Role" TextStyle="TextStyle.Subtitle2" />
                                                @if (string.IsNullOrEmpty(message.Translation))
                                                {
                                                    <div class="rz-text" style="white-space: pre-wrap;">@Vm.RenderMarkdown(message.Content)</div>
                                                }
                                                else
                                                {
                                                    <div class="rz-text" style="white-space: pre-wrap;">@Vm.RenderMarkdown(message.Translation)</div>
												}
                                                <RadzenText Text="@message.Timestamp.ToLocalTime().ToString("g")" TextStyle="TextStyle.Caption" />
                                                @if (message.Role != "user" && message.Stats != null && (message.Stats.TokensUsed != 0 || message.Stats.SecondsElapsed != 0))
                                                {
                                                    <RadzenText Text="@($"Tokens: {message.Stats.TokensUsed} | Elapsed: {message.Stats.SecondsElapsed.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)}s | Tokens/s: {message.Stats.TokensPerSecond.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)}")" TextStyle="TextStyle.Caption" />
                                                }
                                            </RadzenStack>
                                        </ChildContent>
                                    </RadzenCard>
                                    <div class="translate-overlay">
                                        @if (string.IsNullOrEmpty(message.Translation))
                                        {
                                            <RadzenDropDown @bind-Value="selectedTranslateLanguage" Data="languages" Style="width:120px;" />
                                        }
                                        <RadzenButton Icon="language" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Primary" Click="async () => await Vm.TranslateMessageAsync(message, selectedTranslateLanguage)" Text="@(string.IsNullOrEmpty(message.Translation) ? "Translate" : "Original")"></RadzenButton>
                                    </div>
                                </div>
                            }
                        </RadzenStack>
                    }
                </div>
            </ChildContent>
        </RadzenCard>
    </RadzenColumn>
    <RadzenColumn Size="12" SizeLG="4">
        <RadzenCard Variant="Variant.Outlined" Title="Generate">
            <ChildContent>
                <RadzenStack Gap="0.75rem">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <RadzenCheckBox @bind-Value="@Vm.LogKeysEvents" Name="logKeys" TValue="bool" />
                        <RadzenLabel Text="Log Keys Events (Behavioral Analysis)" Component="logKeys" Style="margin-left: 8px; font-size: 0.9rem; opacity: 0.8;" />
                    </div>
                    <RadzenFormField Text="Prompt">
                        <RadzenTextArea id="chatInput"
                                        @bind-Value="@Vm.CurrentPrompt"
                                        Placeholder="Prompt something ..."
                                        @onfocus="Vm.OnInputFocusAsync" />
                    </RadzenFormField>
                    <RadzenRow Gap="0.5rem">
                        <RadzenColumn Size="12" SizeMD="6">
                            <RadzenFormField Text="Max tokens">
                                <RadzenNumeric TValue="int" @bind-Value="Vm.MaxTokens" Min="1" Step="64" />
                            </RadzenFormField>
                        </RadzenColumn>
                        <RadzenColumn Size="12" SizeMD="6">
                            <RadzenFormField Text="Temperature">
                                <RadzenNumeric TValue="float" @bind-Value="Vm.Temperature" Step="0.01" Min="0" Max="2" />
                            </RadzenFormField>
                        </RadzenColumn>
                        <RadzenColumn Size="12" SizeMD="6">
                            <RadzenFormField Text="Top P">
                                <RadzenNumeric TValue="float" @bind-Value="Vm.TopP" Step="0.05" Min="0" Max="1" />
                            </RadzenFormField>
                        </RadzenColumn>
                    </RadzenRow>
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                        <RadzenCheckBox @bind-Value="Vm.StreamResponse" Name="streamResponse" />
                        <RadzenLabel Text="Stream response" Component="streamResponse" />
                    </RadzenStack>
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                        <RadzenCheckBox @bind-Value="Vm.Isolated" Name="isolated" />
                        <RadzenLabel Text="Isolated (no context)" Component="isolated" />
                    </RadzenStack>
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                        <RadzenCheckBox @bind-Value="Vm.UseSystemPrompt" Name="systemprompt" />
                        <RadzenLabel Text="Use system prompt" Component="systemprompt" />
                    </RadzenStack>
                    <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                        <RadzenButton ButtonStyle="ButtonStyle.Light" Text="Images" Click="@Vm.ToggleImagesAsync" />
                    </RadzenStack>
                    @if (Vm.ShowImages)
                    {
                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                            @if (Vm.ImageSelections.Count == 0)
                            {
                                <RadzenText Text="No images available." TextStyle="TextStyle.Caption" />
                            }
                            else
                            {
                                @foreach (var image in Vm.ImageSelections)
                                {
                                    <div style="display: flex; align-items: center; gap: 0.35rem; padding: 0.35rem; border: 1px solid var(--rz-base-200); border-radius: 6px;">
                                        <RadzenCheckBox @bind-Value="image.IsSelected" TValue="bool" />
                                        @if (!string.IsNullOrWhiteSpace(image.Image.ThumbnailBase64))
                                        {
                                            <RadzenImage Path="@($"data:image/png;base64,{image.Image.ThumbnailBase64}")" Style="width: 64px; height: 64px; object-fit: cover;" />
                                        }
                                        else
                                        {
                                            <RadzenText Text="No thumbnail" TextStyle="TextStyle.Caption" />
                                        }
                                    </div>
                                }
                            }
                        </div>
                    }
                    <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                        <RadzenButton ButtonStyle="ButtonStyle.Primary" Text="Send" Click="@Vm.SendAsync" Disabled="@Vm.IsGenerating" />
                        <RadzenButton ButtonStyle="ButtonStyle.Danger" Text="Cancel" Click="@Vm.CancelAsync" Disabled="@(!Vm.IsGenerating)" />
                    </RadzenStack>
                </RadzenStack>
            </ChildContent>
        </RadzenCard>
    </RadzenColumn>
</RadzenRow>

@code {
    private ElementReference messageContainer;
    private ChatViewModel.ChatMessageView? hoveredMessage;
    private string selectedTranslateLanguage = "en";
    private readonly List<string> languages = new() { "en", "de", "fr", "es", "it", "pt", "nl", "ru", "zh-CN", "ja" };

    protected override void OnInitialized()
    {
        Vm.NotifyStateChanged = () => InvokeAsync(StateHasChanged);
    }

    protected override Task OnInitializedAsync()
    {
        return Vm.InitializeAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            Vm.SetMessageContainer(messageContainer);
            // Ensure keystroke logger attaches focus/start handlers to the prompt field
            try
            {
                await JS.InvokeVoidAsync("keystrokeLogger.attachFocusStart", "chatInput");
            }
            catch { }
        }

        await Vm.ApplyScrollAsync();
    }

    private void OnMessageHover(ChatViewModel.ChatMessageView message)
    {
        hoveredMessage = message;
        StateHasChanged();
    }

    private void OnMessageOut()
    {
        hoveredMessage = null;
        StateHasChanged();
    }

    private async Task TranslateHoveredMessage()
    {
        if (hoveredMessage != null)
        {
            await Vm.TranslateMessageAsync(hoveredMessage, selectedTranslateLanguage);
			StateHasChanged();
        }
    }
}
