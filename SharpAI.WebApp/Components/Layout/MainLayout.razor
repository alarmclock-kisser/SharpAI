@inherits LayoutComponentBase
@using TextCopy
@using Microsoft.AspNetCore.Components.Web
@inject IJSRuntime JS

<RadzenLayout>
    <RadzenHeader>
        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween" Gap="1rem" Style="width: 100%;">
            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.75rem">
                <RadzenSidebarToggle Expanded="@sidebarExpanded" Click="@ToggleSidebar" />
                <RadzenText Text="SharpAI.WebApp" TextStyle="TextStyle.Subtitle1" />
            </RadzenStack>
            <RadzenLink Path="https://learn.microsoft.com/aspnet/core/" Text="About" Target="_blank" />
        </RadzenStack>
    </RadzenHeader>

    <RadzenSidebar @bind-Expanded="sidebarExpanded" ExpandedWidth="@sidebarWidth" CollapsedWidth="@collapsedWidth" Style="@sidebarStyle">
        <div id="sidebar-content" class="sidebar-content">
            <NavMenu Collapsed="@(!sidebarExpanded)" />
            <SidebarLog />
        </div>
    </RadzenSidebar>

    <div class="sidebar-resizer-overlay" style="position:fixed;top:56px;bottom:0;left:var(--sidebar-width,260px);width:10px;margin-left:-5px;cursor:col-resize;z-index:9999;background:rgba(0,0,0,0.06);" @onpointerdown="StartResize" title="Resize sidebar"></div>

    <RadzenBody>
        <RadzenStack Gap="1rem">
            @Body
        </RadzenStack>
    </RadzenBody>
</RadzenLayout>

@code {
    private bool sidebarExpanded = true;
    private string sidebarWidth = "260px";
    private string collapsedWidth = "64px";

    private DotNetObjectReference<MainLayout>? objRef;

    private async Task ToggleSidebar()
    {
        sidebarExpanded = !sidebarExpanded;
        await ApplySidebarWidthAsync();
    }

    private async Task StartResize(PointerEventArgs e)
    {
        await JS.InvokeVoidAsync("sidebarStartResize", e.ClientX, objRef);
    }

    [JSInvokable]
    public async Task OnSidebarResized(string width)
    {
        if (!string.IsNullOrWhiteSpace(width))
        {
            sidebarWidth = width;
        }

        await ApplySidebarWidthAsync();
    }

    private string sidebarStyle => $"width:{sidebarWidth};min-width:var(--sidebar-min-width);position:relative;overflow:hidden;";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            objRef = DotNetObjectReference.Create(this);
            var saved = await JS.InvokeAsync<string>("sidebarGetWidth");
            if (!string.IsNullOrWhiteSpace(saved))
            {
                sidebarWidth = saved;
            }
            await ApplySidebarWidthAsync();
            StateHasChanged();
        }
    }

    private async Task ApplySidebarWidthAsync()
    {
        var currentWidth = sidebarExpanded ? sidebarWidth : collapsedWidth;
        await JS.InvokeVoidAsync("sidebarApplyWidth", currentWidth);
    }

    public void Dispose()
    {
        objRef?.Dispose();
    }
}
